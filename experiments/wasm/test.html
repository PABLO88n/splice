<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Splice Wasm Example</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVQYV2NkYGD4z0AEYBxVSFIAAAQAAAD//wMAAAAASUVORK5CYII=">
  </head>
  <body>
    <script type="module">

      import init, { WasmRuntime } from './splice_core/pkg/splice_core.js';
      await init();

      const rt = new WasmRuntime(["Object", "Array"], 8);
      rt.use_logger("error");
      await rt.register_builtin("Object", "call", "Echo");
      const payload = new Uint8Array([1,2,3,4]);
      const res = await rt.dispatch_signal("call", "Object", payload);
      console.log("Signal returned:", res);
      rt.on_signal("call", (frame) => {
        console.log("subscriber frame:", frame);
      });
      rt.emit_signal_by_name("call", { foo: 42 });
      rt.register_js_handler("Array", "call", (ctx) => {
        const len = ctx.frame.payload.length ?? 0;
        return len;
      });
      const r2 = await rt.dispatch_signal("call", "Array", new Uint8Array([9,9,9]));
      console.log("JS handler returned:", r2);
      console.log("metrics:", rt.metrics());
      rt.set_fallback((ctx) => {
        console.warn("Fallback for", ctx.frame.object, ":", ctx.actionId);
        return { status: "fallback", payload: ctx.frame.payload };
      });
      const r3 = await rt.dispatch_signal("get", "Object", new Uint8Array([1]));
      console.log("Fallback returned:", r3);

      const N = 10;
      const t0 = performance.now();
      for (let i = 0; i < N; i++) {
        rt.dispatch_signal("call", "Object", payload);
      }
      const t1 = performance.now();
      console.log(`Dispatched ${N} signals in ${t1 - t0}ms`);

      console.log("summary:", rt.get_summary());

/*

*/






</script>
  </body>
</html>

